TeamCity example deployment
===========================

## Table of Contents

- [Before you start](#before-you-start)
- [TL;DR](#tldr)
- [What does it do](#what-does-it-do)
- [SSL certificate for Nginx](#ssl-certificate-for-nginx)
- [Requirements](#requirements)
- [Cleanup](#cleanup)

_(TOC generated by [markdown-toc](https://github.com/jonschlinkert/markdown-toc))_

Before you start
----------------

This project builds and starts Docker container. You have to have a local Docker engine installed first.

TL;DR
-----

```bash
virtualenv venv
. venv/bin/activate
pip install -r requirements-lock.txt
docker-compose up -d
# TeamCity will be available as https://localhost
# when you done and you want to clean up
docker-compose down --volumes --remove-orphans --rmi local
```

What does it do
---------------

* Orchestrates with Docker compose Nginx to be in a front of the TeamCity server
* adds a single TeamCity agent and points it to the TeamCity server, 
* see [docker-compose.yml]

SSL certificate for Nginx
------------------------------

Nginx uses a self-signed [localhost.crt] certificate. It has been generated with
the following command:

```bash
openssl req -x509 -nodes \
  -days 365 \
  -newkey rsa:2048 \
  -subj '/CN=localhost' \
  -keyout nginx/localhost.key \
  -out nginx/localhost.crt
```

The deploy and start the example use the `docker-compose up` command:

```bash
. venv/bin/activate
docker-compose up -d
```

This downloads required Docker images, for Nginx, TeamCity server and agent.
After the `docker-compose` command finishes, the TeamCity server is available at ports
`80` and `443`

```bash
curl --cacert nginx/localhost.crt https://localhost
```

Requirements
------------

* Python
* Virtualenv
* Docker engine

Cleanup
-------

You can remove all Docker resources created by this project with `docker-compose down` command

```bash
. venv/bin/activate
docker-compose down --volumes --remove-orphans --rmi local
```

This takes care to stop and remove any Docker containers, removes a Docker image with
the web application created by `docker up` command, removes a Docker volume with
Redis persistent storage and the local network.

[docker-compose.yml]: ./docker-compose.yml
[localhost.crt]: ./nginx/localhost.crt
